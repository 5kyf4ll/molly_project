{"ast":null,"code":"var _jsxFileName = \"/home/luis/molly_project/frontend/src/pages/Dashboard/ChatPage.jsx\",\n  _s = $RefreshSig$();\n// src/pages/Dashboard/ChatPage.jsx\nimport React, { useState, useEffect, useRef, useCallback } from \"react\";\nimport { Loader2, Send, Terminal, MessageSquare, Loader, CheckCircle, AlertTriangle, FileText, XCircle, Zap } from \"lucide-react\";\n\n// Importar funciones de API (asumiendo que este archivo existe)\nimport { sendChatMessage, getSessionStatus, checkScanStatus } from '../../api/mollyApi';\nimport Markdown from 'react-markdown';\nimport { Prism as SyntaxHighlighter } from 'react-syntax-highlighter';\nimport { vscDarkPlus } from 'react-syntax-highlighter/dist/esm/styles/prism';\n\n// Componente para manejar la visualizaci√≥n de c√≥digo en Markdown\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst CodeBlock = {\n  code({\n    node,\n    inline,\n    className,\n    children,\n    ...props\n  }) {\n    const match = /language-(\\w+)/.exec(className || '');\n    return !inline && match ? /*#__PURE__*/_jsxDEV(SyntaxHighlighter, {\n      style: vscDarkPlus,\n      language: match[1],\n      PreTag: \"div\",\n      ...props,\n      children: String(children).replace(/\\n$/, '')\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 17,\n      columnNumber: 13\n    }, this) : /*#__PURE__*/_jsxDEV(\"code\", {\n      className: className,\n      ...props,\n      children: children\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 26,\n      columnNumber: 13\n    }, this);\n  }\n};\n\n// Componente para mostrar el estado del escaneo en la barra de estado\nconst ScanStatusDisplay = ({\n  activeScanId,\n  scanProgress,\n  activeProject\n}) => {\n  if (!activeScanId || !scanProgress) {\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"flex items-center text-sm text-gray-400\",\n      children: [/*#__PURE__*/_jsxDEV(Zap, {\n        className: \"w-4 h-4 mr-2 text-indigo-400\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 38,\n        columnNumber: 17\n      }, this), \"Listo para iniciar.\"]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 37,\n      columnNumber: 13\n    }, this);\n  }\n  switch (scanProgress.status) {\n    case 'in_progress':\n      return /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex items-center text-sm text-yellow-400\",\n        children: [/*#__PURE__*/_jsxDEV(Loader, {\n          className: \"w-4 h-4 mr-2 animate-spin\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 48,\n          columnNumber: 21\n        }, this), \"Escaneo en curso (ID: \", activeScanId, \").\"]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 47,\n        columnNumber: 17\n      }, this);\n    case 'completed':\n      return /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex items-center text-sm text-green-400\",\n        children: [/*#__PURE__*/_jsxDEV(CheckCircle, {\n          className: \"w-4 h-4 mr-2\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 55,\n          columnNumber: 21\n        }, this), \"Escaneo completado.\", scanProgress.report_url && /*#__PURE__*/_jsxDEV(\"a\", {\n          href: scanProgress.report_url,\n          target: \"_blank\",\n          rel: \"noopener noreferrer\",\n          className: \"ml-2 text-blue-400 hover:underline\",\n          children: [\"Ver Reporte \", /*#__PURE__*/_jsxDEV(FileText, {\n            className: \"w-3 h-3 inline ml-1\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 59,\n            columnNumber: 41\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 58,\n          columnNumber: 25\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 54,\n        columnNumber: 17\n      }, this);\n    case 'failed':\n      return /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex items-center text-sm text-red-400\",\n        children: [/*#__PURE__*/_jsxDEV(XCircle, {\n          className: \"w-4 h-4 mr-2\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 67,\n          columnNumber: 21\n        }, this), \"Escaneo ID:\", activeScanId, \" fallido.\"]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 66,\n        columnNumber: 17\n      }, this);\n    default:\n      return /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex items-center text-sm text-gray-500\",\n        children: [/*#__PURE__*/_jsxDEV(AlertTriangle, {\n          className: \"w-4 h-4 mr-2\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 74,\n          columnNumber: 21\n        }, this), \"Estado desconocido.\"]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 73,\n        columnNumber: 17\n      }, this);\n  }\n};\n\n// --------------------------------------------------------\n// ---------------------- CHAT PAGE (Componente Principal) ------------------------\n// --------------------------------------------------------\n_c = ScanStatusDisplay;\nexport default function ChatPage() {\n  _s();\n  const [messages, setMessages] = useState([]);\n  const [isSending, setIsSending] = useState(false);\n  const [inputMessage, setInputMessage] = useState('');\n\n  // Estados del sistema (Molly Orchestrator)\n  const [activeProject, setActiveProject] = useState('Ninguno');\n  const [activeScanId, setActiveScanId] = useState(null);\n  const [scanProgress, setScanProgress] = useState(null); // { status: 'in_progress', reportUrl: null, summary: '' }\n\n  const messagesEndRef = useRef(null);\n\n  // Desplazamiento autom√°tico al final\n  const scrollToBottom = useCallback(() => {\n    var _messagesEndRef$curre;\n    (_messagesEndRef$curre = messagesEndRef.current) === null || _messagesEndRef$curre === void 0 ? void 0 : _messagesEndRef$curre.scrollIntoView({\n      behavior: \"smooth\"\n    });\n  }, []);\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages, scrollToBottom]);\n\n  // --- L√≥gica de la API y el Orquestador ---\n\n  // 1. Obtener estado inicial de la sesi√≥n\n  const fetchSessionStatus = useCallback(async () => {\n    try {\n      const status = await getSessionStatus();\n      setActiveProject(status.active_project || 'Ninguno');\n      setActiveScanId(status.last_scan_id);\n      return status;\n    } catch (error) {\n      console.error('Error al obtener el estado de la sesi√≥n:', error);\n      // Mostrar un error de conexi√≥n si es necesario\n    }\n    return null;\n  }, []);\n\n  // 2. Monitoreo de Escaneo (Polling)\n  useEffect(() => {\n    let intervalId;\n    const monitorScan = async () => {\n      if (activeScanId) {\n        try {\n          const statusData = await checkScanStatus(activeScanId);\n          setScanProgress(statusData);\n          if (statusData.status === 'completed' || statusData.status === 'failed' || statusData.status === 'not_found') {\n            clearInterval(intervalId);\n\n            // Si el escaneo termin√≥, notificamos al usuario en el chat.\n            if (statusData.status === 'completed' && statusData.report_url) {\n              setMessages(prev => [...prev, {\n                sender: 'molly',\n                text: `‚úÖ **Escaneo completado con √©xito** para el proyecto **${activeProject}**!\\n\\n[Ver Reporte PDF](${statusData.report_url})\\n\\n**Resumen de la IA:** ${statusData.summary}`\n              }]);\n            } else if (statusData.status === 'failed') {\n              setMessages(prev => [...prev, {\n                sender: 'molly',\n                text: '‚ö†Ô∏è **Error:** El escaneo fall√≥. Por favor, revisa el comando o el estado del objetivo.'\n              }]);\n            }\n            // Limpiar el ID activo despu√©s de la notificaci√≥n para detener el polling\n            setActiveScanId(null);\n          }\n        } catch (error) {\n          console.error('Error al monitorear escaneo:', error);\n          // Si el error es 404 (not_found), ya no hacemos polling.\n          if (error.message.includes('404')) {\n            clearInterval(intervalId);\n            setActiveScanId(null);\n          }\n        }\n      }\n    };\n\n    // Inicia el polling solo si hay un ID de escaneo activo\n    if (activeScanId && ((scanProgress === null || scanProgress === void 0 ? void 0 : scanProgress.status) === 'in_progress' || scanProgress === null)) {\n      monitorScan(); // Consulta inicial\n      intervalId = setInterval(monitorScan, 5000); // Polling cada 5 segundos\n    }\n    return () => clearInterval(intervalId); // Limpieza al desmontar\n  }, [activeScanId, activeProject, scanProgress]);\n\n  // Carga inicial y Polling del estado de la sesi√≥n (ej. cada 15 segundos)\n  useEffect(() => {\n    fetchSessionStatus();\n    const statusInterval = setInterval(fetchSessionStatus, 15000);\n    return () => clearInterval(statusInterval);\n  }, [fetchSessionStatus]);\n\n  // 3. Funci√≥n de env√≠o de mensaje (con integraci√≥n a la API)\n  const sendMessage = async text => {\n    // A√±adir mensaje del usuario\n    setMessages(prev => [...prev, {\n      sender: \"user\",\n      text\n    }]);\n    setIsSending(true);\n    try {\n      var _apiResponse$response, _apiResponse$response2;\n      const apiResponse = await sendChatMessage(text);\n      const mollyText = ((_apiResponse$response = apiResponse.response) === null || _apiResponse$response === void 0 ? void 0 : _apiResponse$response.text) || \"Lo siento, hubo un problema al generar la respuesta.\";\n\n      // Actualizar el proyecto activo\n      setActiveProject(apiResponse.active_project || 'Ninguno');\n\n      // --- Manejo de artefacto (Inicio de Escaneo) ---\n      const artifact = (_apiResponse$response2 = apiResponse.response) === null || _apiResponse$response2 === void 0 ? void 0 : _apiResponse$response2.artifact;\n      if (artifact && artifact.type === 'scan_initiated' && artifact.scan_id) {\n        // Configurar el monitoreo para el nuevo escaneo\n        setActiveScanId(artifact.scan_id);\n        setScanProgress({\n          status: 'in_progress',\n          reportUrl: null\n        });\n\n        // A√±adir un mensaje especial al chat sobre el inicio del escaneo\n        const scanNotice = `\\n\\n--- ü§ñ **Molly est√° ejecutando un escaneo Nmap...** ---\\n\\nEl escaneo (ID: ${artifact.scan_id}) ha iniciado. Te notificar√© aqu√≠ cuando el reporte PDF est√© listo.`;\n        setMessages(prev => [...prev, {\n          sender: \"molly\",\n          text: mollyText + scanNotice\n        }]);\n      } else {\n        // Respuesta de chat normal\n        setMessages(prev => [...prev, {\n          sender: \"molly\",\n          text: mollyText\n        }]);\n      }\n    } catch (error) {\n      console.error('Error al enviar mensaje o en la API:', error);\n      setMessages(prev => [...prev, {\n        sender: \"system\",\n        text: `‚ùå Error de conexi√≥n: ${error.message}. Por favor, verifica tu sesi√≥n o el servidor.`\n      }]);\n    } finally {\n      setIsSending(false);\n    }\n  };\n\n  // --- L√≥gica del ChatPanel (Integrada) ---\n\n  const handleSubmit = e => {\n    e.preventDefault();\n    if (inputMessage.trim() && !isSending) {\n      sendMessage(inputMessage.trim());\n      setInputMessage('');\n    }\n  };\n\n  // Renderizado de un mensaje individual\n  const renderMessage = (msg, index) => {\n    const isUser = msg.sender === 'user';\n    const isMolly = msg.sender === 'molly';\n    const isSystem = msg.sender === 'system';\n    const containerClasses = isUser ? 'justify-end' : 'justify-start';\n\n    // Estilo de la burbuja\n    const bubbleClasses = isUser ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-gray-700 text-gray-100 rounded-tl-none';\n\n    // Icono\n    const Icon = isUser ? MessageSquare : isMolly ? Terminal : AlertTriangle;\n    const iconColor = isUser ? 'text-white' : 'text-indigo-400';\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: `flex ${containerClasses} mb-4`,\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        className: `max-w-3xl flex items-start ${isUser ? 'flex-row-reverse' : 'flex-row'}`,\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: `p-2 rounded-full ${isUser ? 'ml-3 bg-indigo-600' : 'mr-3 bg-gray-800'}`,\n          children: /*#__PURE__*/_jsxDEV(Icon, {\n            className: `w-5 h-5 ${iconColor}`\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 262,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 261,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"flex flex-col\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"font-semibold text-xs mb-1 opacity-70\",\n            children: isUser ? 'T√∫' : isMolly ? 'Molly' : 'Sistema'\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 266,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: `p-4 rounded-xl shadow-lg transition-all duration-300 whitespace-pre-wrap ${bubbleClasses}`,\n            children: /*#__PURE__*/_jsxDEV(Markdown, {\n              components: CodeBlock,\n              children: msg.text\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 270,\n              columnNumber: 29\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 269,\n            columnNumber: 25\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 265,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 259,\n        columnNumber: 17\n      }, this)\n    }, index, false, {\n      fileName: _jsxFileName,\n      lineNumber: 255,\n      columnNumber: 13\n    }, this);\n  };\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"flex flex-col h-screen bg-gray-900 text-white\",\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"p-4 bg-gray-800 border-b border-gray-700 shadow-lg flex justify-between items-center sticky top-0 z-10\",\n      children: [/*#__PURE__*/_jsxDEV(\"h1\", {\n        className: \"text-2xl font-bold text-indigo-500\",\n        children: \"Molly AI: Security Orchestrator\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 286,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex items-center space-x-6\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"text-sm\",\n          children: [/*#__PURE__*/_jsxDEV(\"p\", {\n            className: \"font-medium text-gray-400\",\n            children: \"Proyecto Activo:\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 289,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n            className: \"text-white font-bold\",\n            children: activeProject\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 290,\n            columnNumber: 25\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 288,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          children: [/*#__PURE__*/_jsxDEV(\"p\", {\n            className: \"font-medium text-gray-400\",\n            children: \"Estado de Escaneo:\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 293,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(ScanStatusDisplay, {\n            activeScanId: activeScanId,\n            scanProgress: scanProgress,\n            activeProject: activeProject\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 294,\n            columnNumber: 25\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 292,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 287,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 285,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"flex-grow p-6 overflow-y-auto space-y-4\",\n      style: {\n        backgroundColor: '#1e1e1e'\n      },\n      children: [messages.length === 0 ? /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex flex-col items-center justify-center h-full text-center text-gray-600\",\n        children: [/*#__PURE__*/_jsxDEV(Terminal, {\n          className: \"w-12 h-12 mb-4 text-indigo-500\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 307,\n          columnNumber: 25\n        }, this), /*#__PURE__*/_jsxDEV(\"h2\", {\n          className: \"text-xl font-medium\",\n          children: \"Inicia tu conversaci\\xF3n de seguridad\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 308,\n          columnNumber: 25\n        }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n          className: \"text-sm mt-1\",\n          children: \"Preg\\xFAntale a Molly sobre un escaneo, una CVE o un resumen de un reporte.\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 309,\n          columnNumber: 25\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 306,\n        columnNumber: 21\n      }, this) : messages.map(renderMessage), isSending && /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex justify-start\",\n        children: /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"max-w-xs p-3 rounded-xl bg-gray-700 text-gray-100 rounded-tl-none flex items-center space-x-2\",\n          children: [/*#__PURE__*/_jsxDEV(Loader2, {\n            className: \"w-4 h-4 animate-spin text-indigo-400\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 319,\n            columnNumber: 29\n          }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n            children: \"Molly est\\xE1 escribiendo...\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 320,\n            columnNumber: 29\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 318,\n          columnNumber: 25\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 317,\n        columnNumber: 21\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        ref: messagesEndRef\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 325,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 304,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"form\", {\n      onSubmit: handleSubmit,\n      className: \"p-4 bg-gray-900 border-t border-gray-700 sticky bottom-0 z-10\",\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex items-center p-3 bg-gray-800 rounded-xl shadow-inner\",\n        children: [/*#__PURE__*/_jsxDEV(\"input\", {\n          type: \"text\",\n          value: inputMessage,\n          onChange: e => setInputMessage(e.target.value),\n          placeholder: \"Escribe tu comando o pregunta (ej: 'Inicia un escaneo de puertos en 192.168.1.1')\",\n          className: \"flex-grow bg-transparent text-gray-200 placeholder-gray-500 focus:outline-none text-base\",\n          disabled: isSending\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 331,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          type: \"submit\",\n          disabled: !inputMessage.trim() || isSending,\n          className: `ml-3 p-3 rounded-full transition-all duration-200 ${!inputMessage.trim() || isSending ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-indigo-600 text-white hover:bg-indigo-500 shadow-lg hover:shadow-xl'}`,\n          children: isSending ? /*#__PURE__*/_jsxDEV(Loader2, {\n            className: \"w-5 h-5 animate-spin\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 348,\n            columnNumber: 38\n          }, this) : /*#__PURE__*/_jsxDEV(Send, {\n            className: \"w-5 h-5\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 348,\n            columnNumber: 85\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 339,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 330,\n        columnNumber: 17\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 329,\n      columnNumber: 13\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 282,\n    columnNumber: 9\n  }, this);\n}\n_s(ChatPage, \"oaGbN2A+9K/Ggk3BsYAf0g6nveo=\");\n_c2 = ChatPage;\nvar _c, _c2;\n$RefreshReg$(_c, \"ScanStatusDisplay\");\n$RefreshReg$(_c2, \"ChatPage\");","map":{"version":3,"names":["React","useState","useEffect","useRef","useCallback","Loader2","Send","Terminal","MessageSquare","Loader","CheckCircle","AlertTriangle","FileText","XCircle","Zap","sendChatMessage","getSessionStatus","checkScanStatus","Markdown","Prism","SyntaxHighlighter","vscDarkPlus","jsxDEV","_jsxDEV","CodeBlock","code","node","inline","className","children","props","match","exec","style","language","PreTag","String","replace","fileName","_jsxFileName","lineNumber","columnNumber","ScanStatusDisplay","activeScanId","scanProgress","activeProject","status","report_url","href","target","rel","_c","ChatPage","_s","messages","setMessages","isSending","setIsSending","inputMessage","setInputMessage","setActiveProject","setActiveScanId","setScanProgress","messagesEndRef","scrollToBottom","_messagesEndRef$curre","current","scrollIntoView","behavior","fetchSessionStatus","active_project","last_scan_id","error","console","intervalId","monitorScan","statusData","clearInterval","prev","sender","text","summary","message","includes","setInterval","statusInterval","sendMessage","_apiResponse$response","_apiResponse$response2","apiResponse","mollyText","response","artifact","type","scan_id","reportUrl","scanNotice","handleSubmit","e","preventDefault","trim","renderMessage","msg","index","isUser","isMolly","isSystem","containerClasses","bubbleClasses","Icon","iconColor","components","backgroundColor","length","map","ref","onSubmit","value","onChange","placeholder","disabled","_c2","$RefreshReg$"],"sources":["/home/luis/molly_project/frontend/src/pages/Dashboard/ChatPage.jsx"],"sourcesContent":["// src/pages/Dashboard/ChatPage.jsx\nimport React, { useState, useEffect, useRef, useCallback } from \"react\";\nimport { Loader2, Send, Terminal, MessageSquare, Loader, CheckCircle, AlertTriangle, FileText, XCircle, Zap } from \"lucide-react\";\n\n// Importar funciones de API (asumiendo que este archivo existe)\nimport { sendChatMessage, getSessionStatus, checkScanStatus } from '../../api/mollyApi'; \n\nimport Markdown from 'react-markdown';\nimport { Prism as SyntaxHighlighter } from 'react-syntax-highlighter';\nimport { vscDarkPlus } from 'react-syntax-highlighter/dist/esm/styles/prism';\n\n// Componente para manejar la visualizaci√≥n de c√≥digo en Markdown\nconst CodeBlock = {\n    code({ node, inline, className, children, ...props }) {\n        const match = /language-(\\w+)/.exec(className || '');\n        return !inline && match ? (\n            <SyntaxHighlighter\n                style={vscDarkPlus}\n                language={match[1]}\n                PreTag=\"div\"\n                {...props}\n            >\n                {String(children).replace(/\\n$/, '')}\n            </SyntaxHighlighter>\n        ) : (\n            <code className={className} {...props}>\n                {children}\n            </code>\n        );\n    },\n};\n\n// Componente para mostrar el estado del escaneo en la barra de estado\nconst ScanStatusDisplay = ({ activeScanId, scanProgress, activeProject }) => {\n    if (!activeScanId || !scanProgress) {\n        return (\n            <div className=\"flex items-center text-sm text-gray-400\">\n                <Zap className=\"w-4 h-4 mr-2 text-indigo-400\" />\n                Listo para iniciar.\n            </div>\n        );\n    }\n\n    switch (scanProgress.status) {\n        case 'in_progress':\n            return (\n                <div className=\"flex items-center text-sm text-yellow-400\">\n                    <Loader className=\"w-4 h-4 mr-2 animate-spin\" />\n                    Escaneo en curso (ID: {activeScanId}).\n                </div>\n            );\n        case 'completed':\n            return (\n                <div className=\"flex items-center text-sm text-green-400\">\n                    <CheckCircle className=\"w-4 h-4 mr-2\" />\n                    Escaneo completado. \n                    {scanProgress.report_url && (\n                        <a href={scanProgress.report_url} target=\"_blank\" rel=\"noopener noreferrer\" className=\"ml-2 text-blue-400 hover:underline\">\n                            Ver Reporte <FileText className=\"w-3 h-3 inline ml-1\" />\n                        </a>\n                    )}\n                </div>\n            );\n        case 'failed':\n            return (\n                <div className=\"flex items-center text-sm text-red-400\">\n                    <XCircle className=\"w-4 h-4 mr-2\" />\n                    Escaneo ID:{activeScanId} fallido.\n                </div>\n            );\n        default:\n            return (\n                <div className=\"flex items-center text-sm text-gray-500\">\n                    <AlertTriangle className=\"w-4 h-4 mr-2\" />\n                    Estado desconocido.\n                </div>\n            );\n    }\n};\n\n\n// --------------------------------------------------------\n// ---------------------- CHAT PAGE (Componente Principal) ------------------------\n// --------------------------------------------------------\n\nexport default function ChatPage() {\n    const [messages, setMessages] = useState([]);\n    const [isSending, setIsSending] = useState(false);\n    const [inputMessage, setInputMessage] = useState('');\n\n    // Estados del sistema (Molly Orchestrator)\n    const [activeProject, setActiveProject] = useState('Ninguno');\n    const [activeScanId, setActiveScanId] = useState(null);\n    const [scanProgress, setScanProgress] = useState(null); // { status: 'in_progress', reportUrl: null, summary: '' }\n\n    const messagesEndRef = useRef(null);\n\n    // Desplazamiento autom√°tico al final\n    const scrollToBottom = useCallback(() => {\n        messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n    }, []);\n\n    useEffect(() => {\n        scrollToBottom();\n    }, [messages, scrollToBottom]);\n\n    // --- L√≥gica de la API y el Orquestador ---\n\n    // 1. Obtener estado inicial de la sesi√≥n\n    const fetchSessionStatus = useCallback(async () => {\n        try {\n            const status = await getSessionStatus();\n            setActiveProject(status.active_project || 'Ninguno');\n            setActiveScanId(status.last_scan_id);\n            return status;\n        } catch (error) {\n            console.error('Error al obtener el estado de la sesi√≥n:', error);\n            // Mostrar un error de conexi√≥n si es necesario\n        }\n        return null;\n    }, []);\n\n    // 2. Monitoreo de Escaneo (Polling)\n    useEffect(() => {\n        let intervalId;\n        \n        const monitorScan = async () => {\n            if (activeScanId) {\n                try {\n                    const statusData = await checkScanStatus(activeScanId);\n                    setScanProgress(statusData);\n\n                    if (statusData.status === 'completed' || statusData.status === 'failed' || statusData.status === 'not_found') {\n                        clearInterval(intervalId);\n                        \n                        // Si el escaneo termin√≥, notificamos al usuario en el chat.\n                        if (statusData.status === 'completed' && statusData.report_url) {\n                            setMessages(prev => [\n                                ...prev,\n                                {\n                                    sender: 'molly',\n                                    text: `‚úÖ **Escaneo completado con √©xito** para el proyecto **${activeProject}**!\\n\\n[Ver Reporte PDF](${statusData.report_url})\\n\\n**Resumen de la IA:** ${statusData.summary}`\n                                }\n                            ]);\n                        } else if (statusData.status === 'failed') {\n                            setMessages(prev => [\n                                ...prev,\n                                {\n                                    sender: 'molly',\n                                    text: '‚ö†Ô∏è **Error:** El escaneo fall√≥. Por favor, revisa el comando o el estado del objetivo.'\n                                }\n                            ]);\n                        }\n                        // Limpiar el ID activo despu√©s de la notificaci√≥n para detener el polling\n                        setActiveScanId(null); \n                    }\n\n                } catch (error) {\n                    console.error('Error al monitorear escaneo:', error);\n                    // Si el error es 404 (not_found), ya no hacemos polling.\n                    if (error.message.includes('404')) {\n                        clearInterval(intervalId);\n                        setActiveScanId(null);\n                    }\n                }\n            }\n        };\n\n        // Inicia el polling solo si hay un ID de escaneo activo\n        if (activeScanId && (scanProgress?.status === 'in_progress' || scanProgress === null)) {\n            monitorScan(); // Consulta inicial\n            intervalId = setInterval(monitorScan, 5000); // Polling cada 5 segundos\n        }\n\n        return () => clearInterval(intervalId); // Limpieza al desmontar\n    }, [activeScanId, activeProject, scanProgress]);\n\n\n    // Carga inicial y Polling del estado de la sesi√≥n (ej. cada 15 segundos)\n    useEffect(() => {\n        fetchSessionStatus();\n\n        const statusInterval = setInterval(fetchSessionStatus, 15000); \n\n        return () => clearInterval(statusInterval);\n    }, [fetchSessionStatus]);\n\n\n    // 3. Funci√≥n de env√≠o de mensaje (con integraci√≥n a la API)\n    const sendMessage = async (text) => {\n        // A√±adir mensaje del usuario\n        setMessages(prev => [...prev, { sender: \"user\", text }]);\n        setIsSending(true);\n\n        try {\n            const apiResponse = await sendChatMessage(text);\n            \n            const mollyText = apiResponse.response?.text || \"Lo siento, hubo un problema al generar la respuesta.\";\n            \n            // Actualizar el proyecto activo\n            setActiveProject(apiResponse.active_project || 'Ninguno');\n\n            // --- Manejo de artefacto (Inicio de Escaneo) ---\n            const artifact = apiResponse.response?.artifact;\n            \n            if (artifact && artifact.type === 'scan_initiated' && artifact.scan_id) {\n                // Configurar el monitoreo para el nuevo escaneo\n                setActiveScanId(artifact.scan_id);\n                setScanProgress({ status: 'in_progress', reportUrl: null });\n\n                // A√±adir un mensaje especial al chat sobre el inicio del escaneo\n                const scanNotice = `\\n\\n--- ü§ñ **Molly est√° ejecutando un escaneo Nmap...** ---\\n\\nEl escaneo (ID: ${artifact.scan_id}) ha iniciado. Te notificar√© aqu√≠ cuando el reporte PDF est√© listo.`;\n                setMessages(prev => [...prev, { sender: \"molly\", text: mollyText + scanNotice }]);\n            } else {\n                // Respuesta de chat normal\n                setMessages(prev => [...prev, { sender: \"molly\", text: mollyText }]);\n            }\n\n        } catch (error) {\n            console.error('Error al enviar mensaje o en la API:', error);\n            setMessages(prev => [...prev, { sender: \"system\", text: `‚ùå Error de conexi√≥n: ${error.message}. Por favor, verifica tu sesi√≥n o el servidor.` }]);\n        } finally {\n            setIsSending(false);\n        }\n    };\n\n    // --- L√≥gica del ChatPanel (Integrada) ---\n\n    const handleSubmit = (e) => {\n        e.preventDefault();\n        if (inputMessage.trim() && !isSending) {\n            sendMessage(inputMessage.trim());\n            setInputMessage('');\n        }\n    };\n\n    // Renderizado de un mensaje individual\n    const renderMessage = (msg, index) => {\n        const isUser = msg.sender === 'user';\n        const isMolly = msg.sender === 'molly';\n        const isSystem = msg.sender === 'system';\n\n        const containerClasses = isUser ? 'justify-end' : 'justify-start';\n        \n        // Estilo de la burbuja\n        const bubbleClasses = isUser\n            ? 'bg-indigo-600 text-white rounded-br-none'\n            : 'bg-gray-700 text-gray-100 rounded-tl-none';\n        \n        // Icono\n        const Icon = isUser ? MessageSquare : (isMolly ? Terminal : AlertTriangle);\n        const iconColor = isUser ? 'text-white' : 'text-indigo-400';\n        \n        return (\n            <div \n                key={index} \n                className={`flex ${containerClasses} mb-4`}\n            >\n                <div className={`max-w-3xl flex items-start ${isUser ? 'flex-row-reverse' : 'flex-row'}`}>\n                    {/* Icono */}\n                    <div className={`p-2 rounded-full ${isUser ? 'ml-3 bg-indigo-600' : 'mr-3 bg-gray-800'}`}>\n                        <Icon className={`w-5 h-5 ${iconColor}`} />\n                    </div>\n                    {/* Contenido del Mensaje */}\n                    <div className=\"flex flex-col\">\n                        <div className=\"font-semibold text-xs mb-1 opacity-70\">\n                            {isUser ? 'T√∫' : (isMolly ? 'Molly' : 'Sistema')}\n                        </div>\n                        <div className={`p-4 rounded-xl shadow-lg transition-all duration-300 whitespace-pre-wrap ${bubbleClasses}`}>\n                            <Markdown components={CodeBlock}>\n                                {msg.text}\n                            </Markdown>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        );\n    };\n\n\n    return (\n        <div className=\"flex flex-col h-screen bg-gray-900 text-white\">\n            \n            {/* Header / Status Bar */}\n            <div className=\"p-4 bg-gray-800 border-b border-gray-700 shadow-lg flex justify-between items-center sticky top-0 z-10\">\n                <h1 className=\"text-2xl font-bold text-indigo-500\">Molly AI: Security Orchestrator</h1>\n                <div className=\"flex items-center space-x-6\">\n                    <div className=\"text-sm\">\n                        <p className=\"font-medium text-gray-400\">Proyecto Activo:</p>\n                        <p className=\"text-white font-bold\">{activeProject}</p>\n                    </div>\n                    <div>\n                        <p className=\"font-medium text-gray-400\">Estado de Escaneo:</p>\n                        <ScanStatusDisplay \n                            activeScanId={activeScanId} \n                            scanProgress={scanProgress} \n                            activeProject={activeProject} \n                        />\n                    </div>\n                </div>\n            </div>\n\n            {/* √Årea de Chat */}\n            <div className=\"flex-grow p-6 overflow-y-auto space-y-4\" style={{ backgroundColor: '#1e1e1e' }}>\n                {messages.length === 0 ? (\n                    <div className=\"flex flex-col items-center justify-center h-full text-center text-gray-600\">\n                        <Terminal className=\"w-12 h-12 mb-4 text-indigo-500\" />\n                        <h2 className=\"text-xl font-medium\">Inicia tu conversaci√≥n de seguridad</h2>\n                        <p className=\"text-sm mt-1\">Preg√∫ntale a Molly sobre un escaneo, una CVE o un resumen de un reporte.</p>\n                    </div>\n                ) : (\n                    messages.map(renderMessage)\n                )}\n\n                {/* Indicador escribiendo */}\n                {isSending && (\n                    <div className=\"flex justify-start\">\n                        <div className=\"max-w-xs p-3 rounded-xl bg-gray-700 text-gray-100 rounded-tl-none flex items-center space-x-2\">\n                            <Loader2 className=\"w-4 h-4 animate-spin text-indigo-400\" />\n                            <span>Molly est√° escribiendo...</span>\n                        </div>\n                    </div>\n                )}\n                \n                <div ref={messagesEndRef} />\n            </div>\n\n            {/* Caja de texto (Input) */}\n            <form onSubmit={handleSubmit} className=\"p-4 bg-gray-900 border-t border-gray-700 sticky bottom-0 z-10\">\n                <div className=\"flex items-center p-3 bg-gray-800 rounded-xl shadow-inner\">\n                    <input\n                        type=\"text\"\n                        value={inputMessage}\n                        onChange={(e) => setInputMessage(e.target.value)}\n                        placeholder=\"Escribe tu comando o pregunta (ej: 'Inicia un escaneo de puertos en 192.168.1.1')\"\n                        className=\"flex-grow bg-transparent text-gray-200 placeholder-gray-500 focus:outline-none text-base\"\n                        disabled={isSending}\n                    />\n                    <button\n                        type=\"submit\"\n                        disabled={!inputMessage.trim() || isSending}\n                        className={`ml-3 p-3 rounded-full transition-all duration-200 ${\n                            !inputMessage.trim() || isSending\n                                ? 'bg-gray-700 text-gray-500 cursor-not-allowed'\n                                : 'bg-indigo-600 text-white hover:bg-indigo-500 shadow-lg hover:shadow-xl'\n                        }`}\n                    >\n                        {isSending ? <Loader2 className=\"w-5 h-5 animate-spin\" /> : <Send className=\"w-5 h-5\" />}\n                    </button>\n                </div>\n            </form>\n        </div>\n    );\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}